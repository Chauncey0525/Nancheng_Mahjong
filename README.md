# 南城麻将算分小程序

一个基于微信小程序开发的南城麻将算分工具，支持胡分、杠分、码分的自动计算，采用买码规则计算每个方位的正负得分。

## 功能特点

### 核心功能
- ✅ **买码规则计算**：自动计算每个方位（东南西北）与其他三家的正负得分
- ✅ **胡分计算**：支持所有胡牌类型，包括平胡、打烂、七星、碰碰胡、七对、清一色等
- ✅ **杠分计算**：支持点杠和暗杠，自动考虑庄家翻倍
- ✅ **一炮多响**：支持多个玩家同时胡牌，每个玩家可以有不同的胡牌类型
- ✅ **荒庄（流局）**：支持流局情况，不计算胡牌分，只计算杠分和码分
- ✅ **历史记录**：自动保存每局记录，支持查看详情和统计总得分
- ✅ **美观UI**：现代化的渐变背景和卡片式设计，优化的按钮样式

### 胡牌类型支持
| 胡牌类型 | 分数 | 说明 |
|---------|------|------|
| 平胡 | 1分 | |
| 打烂 | 2分 | |
| 七星 | 4分 | |
| 碰碰胡 | 5分 | |
| 七对 | 6分 | |
| 清一色 | 7分 | |
| 清一色碰碰胡/七对 | 10分 | |
| 天胡 | 20分 | 一家给 |
| 地胡 | 20分 | 庄家给胡牌者 |

### 特殊规则
- **庄家翻倍**：庄家输赢都翻倍
- **自摸**：三家给
- **点炮**：放炮方给
- **一炮多响**：支持一炮双响/三响，每个胡牌者可以有不同的胡牌类型
- **荒庄**：流局时不计算胡牌分，只计算杠分和码分

## 算分规则

### 买码规则（核心算法）

每个方位（东南西北）计算与其他三家的正负得分：

**第一步：计算基础得分**
- 对每个玩家，计算与其他玩家的净支付（胡分+杠分）
- 公式：`基础得分 = (对方支付给我) - (我支付给对方)`

**第二步：应用对方码数**
- 公式：`得分 = 基础得分 × (1 + 对方的码数)`
- 倍数规则：
  - 基础倍数为1
  - 每有1只码是多一倍
  - 比如有1只码，则分数是×2，有2只码分数×3...以此类推
  - 公式：倍数 = 1 + 码数

**第三步：应用自己码数**
- 汇总对所有其他玩家的得分
- 公式：`最终得分 = (对所有其他玩家的得分之和) × (1 + 自己的码数)`

**示例**：
- 东方需要支付南方2分胡分，获得他1分码分（杠分），并且南方有4个码
- 对于东方来说，和南方的分数关系为：`(-2 + 1) × (1 + 4) = -5分`
- 同理可算出东方与西方、北方的分数关系
- 假设对西方为：+6分，对北方为：+3分
- 则东方玩家这把的分数为：`(-5 + 6 + 3) = +4分`
- 如果东方自己有2个码，最终得分 = `+4 × (1 + 2) = +12分`

### 杠分规则

**点杠（明杠）**：
- **庄点闲**：点杠者（庄家）给-4分，其他两家闲家各给-1分
- **闲点庄**：点杠者（闲家）给-4分，其他两家各给-2分（因为捡杠者是庄家，需要翻倍）
- **闲点闲**：点杠者（闲家）给-2分，庄家给-2分，另一家闲家给-1分

**暗杠**：
- **庄家暗杠**：其他三家每家给庄家4分
- **闲家暗杠**：其他玩家给2分，如果其他玩家是庄家则给4分

## 项目结构

```
南城麻将/
├── app.json              # 小程序配置（包括TabBar配置）
├── app.js                # 小程序入口
├── app.wxss              # 全局样式
├── sitemap.json          # 站点地图配置
├── project.config.json   # 项目配置
├── images/               # TabBar图标
│   ├── calculator.png           # 算分图标（未选中）
│   ├── calculator-active.png    # 算分图标（选中）
│   ├── history.png              # 历史图标（未选中）
│   ├── history-active.png       # 历史图标（选中）
│   └── generate_icons.py        # 图标生成脚本
├── pages/
│   ├── index/            # 算分主页面
│   │   ├── index.js
│   │   ├── index.wxml
│   │   └── index.wxss
│   └── history/          # 历史记录页面
│       ├── history.js
│       ├── history.wxml
│       └── history.wxss
├── utils/
│   ├── scoring.js        # 算分核心逻辑
│   └── config.js         # 算分规则配置
└── README.md             # 项目说明文档
```

## 使用方法

### 1. 设置玩家信息
- 输入四个方位（东南西北）的玩家名称（默认：东方、南方、西方、北方）
- 输入每个玩家的码数
- 选择庄家（只能选择一个，每局必须有一个庄家）

### 2. 输入胡牌信息
- **荒庄（流局）**：如果本局流局，开启"荒庄"开关，不计算胡牌分
- **一炮多响**：如果多人同时胡牌，开启"一炮多响"开关
- 选择胡牌方式（自摸/点炮）
- 如果点炮，选择点炮者
- 选择胡牌者（一炮多响时可选择多个）
- 选择胡牌类型（一炮多响时每个胡牌者可以选择不同的类型）

### 3. 输入杠分信息
- 点击"添加杠"按钮
- 选择杠的类型（点杠/暗杠）
- 选择捡杠者（执行杠的玩家）
- 如果是点杠，选择放杠者（提供牌的玩家）

### 4. 计算得分
- 点击"计算得分"按钮
- 系统自动计算每个玩家的得分
- 显示详细的得分明细，包括：
  - 对每个其他玩家的得分
  - 基础分、码数、倍数
  - 胡分和杠分明细

### 5. 保存记录
- 计算完成后，点击"保存记录"按钮
- 记录会自动保存到本地存储
- 可在"历史"页面查看所有记录

### 6. 查看历史记录
- 切换到"历史"标签页
- 查看每局的详细信息：
  - 庄家信息
  - 胡牌者、胡牌类型、放炮者
  - 杠的详细信息（杠1：XX捡杠，XX放杠；杠2：...）
  - 每个玩家的得分
- 查看总得分统计
- 支持删除单条记录或清空所有记录

## 技术实现

### 核心技术
- **框架**：微信小程序原生框架
- **存储**：本地存储（wx.setStorageSync）
- **算法**：买码规则计算算法
- **UI设计**：现代化渐变背景、卡片式布局、优化的按钮样式

### 核心算法

买码规则计算流程：
1. 初始化所有玩家之间的得分关系为0
2. 计算每个玩家的胡分（考虑庄家翻倍、自摸/点炮、一炮多响）
3. 依次计算每个杠的杠分（考虑点杠/暗杠、庄家翻倍）
4. 对每个玩家，计算与其他三家的净支付（胡分+杠分）
5. 应用买码规则第一步：`(胡分+杠分) × (1 + 对方码数)`
6. 汇总每个玩家对所有其他玩家的得分
7. 应用买码规则第二步：`(汇总得分) × (1 + 自己码数)`

## 开发说明

### 环境要求
- 微信开发者工具
- Node.js（可选，用于运行图标生成脚本）

### 运行项目
1. 使用微信开发者工具打开项目
2. 选择"南城麻将"目录
3. 点击"编译"按钮运行

### 配置说明
- `app.json`：小程序全局配置，包括页面路径、窗口样式、tabBar等
- `utils/config.js`：算分规则配置，可在此修改胡分、杠分规则
- `utils/scoring.js`：算分核心逻辑，实现买码规则计算

### 图标生成
如果需要重新生成TabBar图标，可以运行：
```bash
cd images
python generate_icons.py
```
需要安装Pillow库：`pip install Pillow`

## 注意事项

1. **码数输入**：确保输入的码数为非负整数
2. **庄家选择**：每局只能选择一个庄家，且必须有一个庄家
3. **胡牌信息**：
   - 非荒庄情况下，必须至少选择一个有效的胡牌者和胡牌类型
   - 一炮多响时，所有胡牌者必须不同
   - 点炮时，胡牌者不能是点炮者
4. **点炮信息**：如果选择点炮，必须选择点炮者
5. **杠分信息**：
   - 如果添加了杠，必须完整填写杠的信息
   - 点杠时，捡杠者和放杠者不能是同一人
6. **历史记录**：最多保存100条记录，超出会自动删除最旧的记录

## 更新日志

### v1.2.0 (2026-01-15)
- ✅ 优化UI样式：现代化渐变背景、优化按钮样式
- ✅ 添加TabBar图标：算分和历史页面图标
- ✅ 优化历史记录显示：显示庄家、胡牌者、放炮者、杠的详细信息
- ✅ 修复庄家暗杠逻辑：庄家暗杠时其他三家每家给4分
- ✅ 修复清空重来功能：修复点击后无法使用选择器的问题

### v1.1.0 (2026-01-14)
- ✅ 添加荒庄（流局）功能：不计算胡牌分，只计算杠分和码
- ✅ 完善一炮多响功能：支持每个胡牌者选择不同的胡牌类型
- ✅ 优化点杠规则：精确实现庄点闲、闲点庄、闲点闲三种情况
- ✅ 修改杠的称呼：捡杠者（得分）、放杠者（失分）
- ✅ 优化UI显示和交互逻辑

### v1.0.0 (2026-01-14)
- ✅ 实现买码规则计算算法
- ✅ 支持所有胡牌类型
- ✅ 支持点杠和暗杠计算
- ✅ 支持自摸和点炮
- ✅ 支持一炮多响
- ✅ 实现历史记录功能
- ✅ 完整的移动端UI设计

## 许可证

本项目仅供学习和个人使用。

## 联系方式

如有问题或建议，欢迎提交Issue或Pull Request。

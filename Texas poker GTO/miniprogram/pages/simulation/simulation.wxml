<!--pages/simulation/simulation.wxml-->
<view class="container">
  <view wx:if="{{!gameState}}" class="game-setup">
    <view class="card">
      <view class="title">æ¸¸æˆè®¾ç½®</view>
      <view class="setting-item">
        <text>ç©å®¶æ•°é‡</text>
        <picker mode="selector" range="{{[2,3,4,5,6]}}" value="{{gameSettings.playerCount - 2}}" bindchange="onPlayerCountChange">
          <view class="picker">{{gameSettings.playerCount}}äºº</view>
        </picker>
      </view>
      <view class="setting-item">
        <text>åˆå§‹ç­¹ç </text>
        <input class="input" type="number" value="{{gameSettings.initialChips}}" bindinput="onChipsChange" />
      </view>
      <view class="setting-item">
        <text>å°ç›²æ³¨</text>
        <input class="input" type="number" value="{{gameSettings.smallBlind}}" bindinput="onSmallBlindChange" />
      </view>
      <view class="setting-item">
        <text>å¤§ç›²æ³¨</text>
        <input class="input" type="number" value="{{gameSettings.bigBlind}}" bindinput="onBigBlindChange" />
      </view>
      <button class="btn btn-primary" bindtap="startNewGame">å¼€å§‹æ¸¸æˆ</button>
    </view>
  </view>

  <view wx:else class="game-board">
    <!-- æ¸¸æˆä¿¡æ¯ -->
    <view class="game-info card">
      <view class="info-row">
        <text>åº•æ± : {{gameState.pot}}</text>
        <text>å½“å‰ä¸‹æ³¨: {{gameState.currentBet}}</text>
      </view>
      <view class="info-row">
        <text>é˜¶æ®µ: {{gameState.gamePhase}}</text>
        <text>å½“å‰ç©å®¶: {{gameState.players[gameState.currentPlayerIndex].name}}</text>
      </view>
    </view>

    <!-- å…¬å…±ç‰Œ -->
    <view class="card">
      <view class="title">å…¬å…±ç‰Œ</view>
      <view class="community-cards">
        <view class="card-item" wx:for="{{gameState.communityCards}}" wx:key="index">
          <text class="card-suit">{{item.suit}}</text>
          <text class="card-rank">{{item.rank}}</text>
        </view>
      </view>
    </view>

    <!-- ç©å®¶ä¿¡æ¯ -->
    <view class="players-section">
      <view class="player-card" wx:for="{{gameState.players}}" wx:key="id" wx:for-item="player">
        <view class="player-header">
          <text class="player-name">{{player.name}}</text>
          <text class="player-chips">ç­¹ç : {{player.chips}}</text>
        </view>
        <view class="player-cards" wx:if="{{player.isHuman || gameState.gamePhase === 'ended'}}">
          <view class="card-item" wx:for="{{player.cards}}" wx:key="index" wx:for-item="card">
            <text class="card-suit">{{card.suit}}</text>
            <text class="card-rank">{{card.rank}}</text>
          </view>
        </view>
        <view wx:else class="card-back">ğŸ‚ </view>
        <view class="player-status">
          <text wx:if="{{player.folded}}">å·²å¼ƒç‰Œ</text>
          <text wx:if="{{player.allIn}}">å…¨æŠ¼</text>
          <text wx:if="{{player.currentBet > 0}}">ä¸‹æ³¨: {{player.currentBet}}</text>
        </view>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view wx:if="{{gameState.players[gameState.currentPlayerIndex].isHuman && !gameState.players[gameState.currentPlayerIndex].folded}}" class="action-buttons card">
      <button class="btn btn-primary" bindtap="getGTOAdvice">è·å–GTOå»ºè®®</button>
      <button class="btn btn-secondary" bindtap="onCheck" wx:if="{{gameState.currentBet === 0}}">è¿‡ç‰Œ</button>
      <button class="btn btn-secondary" bindtap="onCall" wx:if="{{gameState.currentBet > 0}}">è·Ÿæ³¨</button>
      <button class="btn btn-secondary" bindtap="onBet">ä¸‹æ³¨</button>
      <button class="btn btn-danger" bindtap="onFold">å¼ƒç‰Œ</button>
      <button class="btn btn-danger" bindtap="onAllIn">å…¨æŠ¼</button>
    </view>

    <!-- GTOå»ºè®®å¼¹çª— -->
    <view wx:if="{{showGTOAdvice}}" class="gto-modal" bindtap="closeGTOAdvice">
      <view class="gto-content" catchtap="stopPropagation">
        <view class="gto-header">
          <text class="title">GTOå»ºè®®</text>
          <text class="close-btn" bindtap="closeGTOAdvice">Ã—</text>
        </view>
        <view wx:if="{{isLoading}}" class="loading">åŠ è½½ä¸­...</view>
        <view wx:else class="gto-body">
          <view wx:if="{{gtoAdvice}}">
            <view class="advice-item">
              <text>æ¨èåŠ¨ä½œ: {{gtoAdvice.recommendedAction}}</text>
            </view>
            <view class="advice-item">
              <text>æœŸæœ›ä»·å€¼: {{gtoAdvice.ev}}</text>
            </view>
            <view class="advice-item" wx:if="{{gtoAdvice.frequencies}}">
              <text>åŠ¨ä½œé¢‘ç‡:</text>
              <text>å¼ƒç‰Œ: {{gtoAdvice.frequencies.fold}}%</text>
              <text>è·Ÿæ³¨: {{gtoAdvice.frequencies.call}}%</text>
              <text>åŠ æ³¨: {{gtoAdvice.frequencies.raise}}%</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>

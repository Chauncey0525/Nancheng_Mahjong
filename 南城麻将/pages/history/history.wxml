<!--pages/history/history.wxml-->
<view class="container">
  <view class="header">
    <text class="header-title">å†å²è®°å½•</text>
    <text class="header-count" wx:if="{{history.length > 0}}">å…±{{history.length}}æ¡</text>
  </view>

  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <view class="card" wx:if="{{history.length > 0}}">
    <view class="card-title">æ€»å¾—åˆ†ç»Ÿè®¡</view>
    <view class="stats-section">
      <view class="stat-item" wx:for="{{totalScores}}" wx:key="playerIndex">
        <text class="stat-name">{{item.playerName}}</text>
        <text class="stat-value {{item.totalScore >= 0 ? 'positive' : 'negative'}}">
          {{item.totalScore >= 0 ? '+' : ''}}{{item.totalScore}}åˆ†
        </text>
      </view>
    </view>
  </view>

  <!-- å†å²è®°å½•åˆ—è¡¨ -->
  <view class="history-list" wx:if="{{history.length > 0}}">
    <view class="history-item card" wx:for="{{history}}" wx:key="id" bindtap="viewDetail" data-index="{{index}}">
      <view class="history-header">
        <text class="history-time">{{item.timestamp}}</text>
        <text class="delete-btn" catchtap="deleteRecord" data-id="{{item.id}}">åˆ é™¤</text>
      </view>
      <view class="history-summary">
        <view class="summary-row">
          <text class="summary-label">èƒ¡ç‰Œè€…:</text>
          <text class="summary-value">{{item.winInfo.winnerIndex >= 0 ? item.players[item.winInfo.winnerIndex].name : 'æœªè®¾ç½®'}}</text>
        </view>
        <view class="summary-row">
          <text class="summary-label">èƒ¡ç‰Œç±»å‹:</text>
          <text class="summary-value">{{item.winInfo.winType || 'æœªè®¾ç½®'}}</text>
        </view>
        <view class="summary-row">
          <text class="summary-label">æ–¹å¼:</text>
          <text class="summary-value">{{item.winInfo.isSelfDraw ? 'è‡ªæ‘¸' : 'ç‚¹ç‚®'}}</text>
        </view>
      </view>
      <view class="history-results">
        <view class="result-mini" wx:for="{{item.results}}" wx:key="playerIndex" wx:for-item="result">
          <text class="result-mini-name">{{result.playerName}}</text>
          <text class="result-mini-score {{(result.subTotalScore !== undefined ? result.subTotalScore : result.totalScore) >= 0 ? 'positive' : 'negative'}}">
            {{(result.subTotalScore !== undefined ? result.subTotalScore : result.totalScore) >= 0 ? '+' : ''}}{{result.subTotalScore !== undefined ? result.subTotalScore : result.totalScore}}
          </text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty-state" wx:if="{{history.length === 0}}">
    <text class="empty-state-icon">ğŸ“</text>
    <text class="empty-state-text">æš‚æ— å†å²è®°å½•</text>
    <text class="empty-state-hint">åœ¨ç®—åˆ†é¡µé¢ä¿å­˜è®°å½•åï¼Œä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ</text>
  </view>

  <!-- æ¸…ç©ºæŒ‰é’® -->
  <view class="action-buttons" wx:if="{{history.length > 0}}">
    <button class="btn btn-danger" bindtap="clearAll">æ¸…ç©ºæ‰€æœ‰è®°å½•</button>
  </view>
</view>

<!-- è¯¦æƒ…å¼¹çª— -->
<view class="modal" wx:if="{{showDetail}}" bindtap="closeDetail">
  <view class="modal-content" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">è®°å½•è¯¦æƒ…</text>
      <text class="modal-close" bindtap="closeDetail">Ã—</text>
    </view>
    <view class="modal-body" wx:if="{{currentDetail}}">
      <view class="detail-section">
        <view class="detail-title">ç©å®¶ä¿¡æ¯</view>
        <view class="detail-item" wx:for="{{currentDetail.players}}" wx:key="index">
          <text>{{item.name}}</text>
          <text>ç æ•°: {{item.ma}}</text>
          <text wx:if="{{item.isDealer}}" class="tag tag-primary">åº„å®¶</text>
        </view>
      </view>
      <view class="detail-section">
        <view class="detail-title">èƒ¡ç‰Œä¿¡æ¯</view>
        <view class="detail-item">
          <text>èƒ¡ç‰Œè€…: {{currentDetail.players[currentDetail.winInfo.winnerIndex].name}}</text>
        </view>
        <view class="detail-item">
          <text>ç±»å‹: {{currentDetail.winInfo.winType}}</text>
        </view>
        <view class="detail-item">
          <text>æ–¹å¼: {{currentDetail.winInfo.isSelfDraw ? 'è‡ªæ‘¸' : 'ç‚¹ç‚®'}}</text>
        </view>
        <view class="detail-item" wx:if="{{!currentDetail.winInfo.isSelfDraw}}">
          <text>ç‚¹ç‚®è€…: {{currentDetail.players[currentDetail.winInfo.shooterIndex].name}}</text>
        </view>
      </view>
      <view class="detail-section" wx:if="{{currentDetail.gangInfo.length > 0}}">
        <view class="detail-title">æ åˆ†ä¿¡æ¯</view>
        <view class="detail-item" wx:for="{{currentDetail.gangInfo}}" wx:key="index">
          <text>{{item.type}}</text>
          <text>æ çš„ç©å®¶: {{currentDetail.players[item.playerIndex].name}}</text>
          <text wx:if="{{item.type === 'ç‚¹æ '}}">ç‚¹æ è€…: {{currentDetail.players[item.pointGangIndex].name}}</text>
        </view>
      </view>
      <view class="detail-section">
        <view class="detail-title">å¾—åˆ†ç»“æœ</view>
        <view class="detail-item" wx:for="{{currentDetail.results}}" wx:key="playerIndex">
          <text>{{item.playerName}}</text>
          <text class="{{(item.subTotalScore !== undefined ? item.subTotalScore : item.totalScore) >= 0 ? 'positive' : 'negative'}}">
            {{(item.subTotalScore !== undefined ? item.subTotalScore : item.totalScore) >= 0 ? '+' : ''}}{{item.subTotalScore !== undefined ? item.subTotalScore : item.totalScore}}åˆ†
          </text>
        </view>
      </view>
    </view>
  </view>
</view>

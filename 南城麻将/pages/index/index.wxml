<!--pages/index/index.wxml-->
<view class="container">
  <!-- 玩家信息设置 -->
  <view class="card">
    <view class="card-title">玩家信息</view>
    <view class="players-section">
      <view class="player-item" wx:for="{{players}}" wx:key="index">
        <view class="player-header">
          <text class="player-name">{{item.name}}</text>
          <switch checked="{{item.isDealer}}" bindchange="onDealerChange" data-index="{{index}}" class="dealer-switch"/>
          <text class="dealer-label">庄家</text>
        </view>
        <view class="input-group">
          <text class="input-label">码数</text>
          <input class="input ma-input" type="number" value="{{item.ma}}" placeholder="请输入码数" 
                 bindinput="onMaInput" data-index="{{index}}"/>
        </view>
      </view>
    </view>
  </view>

  <!-- 胡牌信息输入 -->
  <view class="card">
    <view class="card-title">胡牌信息</view>
    
    <view class="input-group">
      <view class="draw-game-container">
        <text class="input-label">荒庄（流局）</text>
        <switch checked="{{winInfo.isDrawGame}}" bindchange="onDrawGameChange" class="draw-game-switch"/>
        <text class="draw-game-label">不计算胡牌分，只计算杠分和码</text>
      </view>
    </view>
    
    <view class="input-group" wx:if="{{!winInfo.isDrawGame}}">
      <view class="draw-game-container">
        <text class="input-label">一炮多响</text>
        <switch checked="{{winInfo.isMultiWin}}" bindchange="onMultiWinToggle" class="draw-game-switch"/>
        <text class="draw-game-label">多人同时胡牌</text>
      </view>
    </view>

    <view class="input-group" wx:if="{{!winInfo.isDrawGame}}">
      <text class="input-label">胡牌方式</text>
      <radio-group class="radio-group" bindchange="onWinMethodChange">
        <label class="radio-item">
          <radio value="selfDraw" checked="{{winInfo.isSelfDraw}}"/>自摸
        </label>
        <label class="radio-item">
          <radio value="shoot" checked="{{!winInfo.isSelfDraw}}"/>点炮
        </label>
      </radio-group>
    </view>

    <view class="input-group" wx:if="{{!winInfo.isDrawGame && !winInfo.isSelfDraw}}">
      <text class="input-label">点炮者</text>
      <picker mode="selector" range="{{playerNames}}" range-key="name" value="{{winInfo.shooterIndex >= 0 ? winInfo.shooterIndex + 1 : 0}}" 
              bindchange="onShooterChange">
        <view class="picker">{{winInfo.shooterIndex >= 0 ? playerNames[winInfo.shooterIndex + 1].name : '无'}}</view>
      </picker>
    </view>

    <!-- 非一炮多响模式：单个胡牌者 -->
    <view wx:if="{{!winInfo.isDrawGame && !winInfo.isMultiWin}}">
      <view class="input-group">
        <text class="input-label">胡牌者</text>
        <picker mode="selector" range="{{playerNames}}" range-key="name" value="{{winInfo.winners[0] && winInfo.winners[0].playerIndex >= 0 ? winInfo.winners[0].playerIndex + 1 : 0}}" 
                bindchange="onWinnerSelect" data-winner-index="0">
          <view class="picker">{{winInfo.winners[0] && winInfo.winners[0].playerIndex >= 0 ? playerNames[winInfo.winners[0].playerIndex + 1].name : '无'}}</view>
        </picker>
      </view>

      <view class="input-group">
        <text class="input-label">胡牌类型</text>
        <picker mode="selector" range="{{winTypes}}" value="{{winInfo.winners[0] && winInfo.winners[0].winType ? (winTypes.indexOf(winInfo.winners[0].winType) >= 0 ? winTypes.indexOf(winInfo.winners[0].winType) : 0) : 0}}" 
                bindchange="onWinTypeSelect" data-winner-index="0">
          <view class="picker">{{winInfo.winners[0] && winInfo.winners[0].winType ? winInfo.winners[0].winType : '无'}}</view>
        </picker>
      </view>
    </view>

    <!-- 一炮多响模式：多个胡牌者 -->
    <view wx:if="{{!winInfo.isDrawGame && winInfo.isMultiWin && !winInfo.isSelfDraw}}">
      <view wx:for="{{winInfo.winners}}" wx:key="index" wx:for-item="winner" wx:for-index="winnerIndex">
        <view class="input-group">
          <text class="winner-label">胡牌者{{winnerIndex + 1}}<text wx:if="{{winnerIndex > 0}}" style="color: #999; font-size: 24rpx;">（可选）</text></text>
          <picker mode="selector" range="{{playerNames}}" range-key="name" 
                  value="{{winner.playerIndex >= 0 ? winner.playerIndex + 1 : 0}}" 
                  bindchange="onWinnerSelect" data-winner-index="{{winnerIndex}}">
            <view class="picker">{{winner.playerIndex >= 0 ? playerNames[winner.playerIndex + 1].name : '无'}}</view>
          </picker>
        </view>
        <view class="input-group">
          <text class="winner-label">胡牌类型{{winnerIndex + 1}}<text wx:if="{{winnerIndex > 0}}" style="color: #999; font-size: 24rpx;">（可选）</text></text>
          <picker mode="selector" range="{{winTypes}}" 
                  value="{{winner.winType ? (winTypes.indexOf(winner.winType) >= 0 ? winTypes.indexOf(winner.winType) : 0) : 0}}" 
                  bindchange="onWinTypeSelect" data-winner-index="{{winnerIndex}}">
            <view class="picker">{{winner.winType || '无'}}</view>
          </picker>
        </view>
      </view>
    </view>
  </view>

  <!-- 杠分信息输入 -->
  <view class="card">
    <view class="card-title">杠分信息</view>
    <view class="gang-list">
      <view class="gang-item" wx:for="{{gangInfo}}" wx:key="index">
        <view class="gang-header">
          <text>杠 {{index + 1}}</text>
          <text class="delete-btn" bindtap="deleteGang" data-index="{{index}}">删除</text>
        </view>
        <view class="input-group">
          <text class="input-label">杠的类型</text>
          <picker mode="selector" range="{{gangTypes}}" value="{{item.gangTypeIndex}}" 
                  bindchange="onGangTypeChange" data-gang-index="{{index}}">
            <view class="picker">{{gangTypes[item.gangTypeIndex] || '请选择'}}</view>
          </picker>
        </view>
        <view class="input-group">
          <text class="input-label">捡杠者</text>
          <picker mode="selector" range="{{playerNamesForGang}}" range-key="name" value="{{item.playerIndex >= 0 ? item.playerIndex : 0}}" 
                  bindchange="onGangPlayerChange" data-gang-index="{{index}}">
            <view class="picker">{{item.playerIndex >= 0 ? playerNamesForGang[item.playerIndex].name : playerNamesForGang[0].name}}</view>
          </picker>
        </view>
        <view class="input-group" wx:if="{{item.type === '点杠'}}">
          <text class="input-label">放杠者</text>
          <picker mode="selector" range="{{playerNamesForGang}}" range-key="name" value="{{item.pointGangIndex >= 0 ? item.pointGangIndex : 0}}" 
                  bindchange="onPointGangChange" data-gang-index="{{index}}">
            <view class="picker">{{item.pointGangIndex >= 0 ? playerNamesForGang[item.pointGangIndex].name : playerNamesForGang[0].name}}</view>
          </picker>
        </view>
      </view>
    </view>
    <button class="btn btn-secondary" bindtap="addGang">添加杠</button>
  </view>

  <!-- 计算结果展示 -->
  <view class="card" wx:if="{{results.length > 0}}">
    <view class="card-title">计算结果</view>
    <view class="results-section">
      <view class="result-item" wx:for="{{results}}" wx:key="playerIndex">
        <view class="result-header">
          <text class="result-label">{{item.playerName}}</text>
          <text class="result-value {{item.subTotalScore >= 0 ? 'positive' : 'negative'}}">
            {{item.subTotalScore >= 0 ? '+' : ''}}{{item.subTotalScore}}分
          </text>
        </view>
        <view class="result-details">
          <view class="detail-item" wx:for="{{item.details}}" wx:key="targetIndex" wx:for-item="detail">
            <view class="detail-row">
              <text class="detail-text">对{{detail.targetName}}: {{detail.score >= 0 ? '+' : ''}}{{detail.score}}分</text>
            </view>
            <view class="detail-info-row">
              <text class="detail-base">基础分:{{detail.baseScore >= 0 ? '+' : ''}}{{detail.baseScore}}, 码数:{{detail.ma}}, 倍数:{{detail.multiplier}}</text>
              <text class="detail-breakdown" wx:if="{{detail.winScore !== undefined || detail.gangScore !== undefined}}">
                胡分:{{detail.winScore >= 0 ? '+' : ''}}{{detail.winScore || 0}}, 杠分:{{detail.gangScore >= 0 ? '+' : ''}}{{detail.gangScore || 0}}
              </text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 操作按钮 -->
  <view class="action-buttons">
    <button class="btn btn-primary" bindtap="calculateScore">计算得分</button>
    <button class="btn btn-success" bindtap="saveRecord" disabled="{{results.length === 0}}">保存记录</button>
    <button class="btn btn-secondary" bindtap="resetForm">清空重来</button>
  </view>
</view>
